# version format
version: 1.0.{build}
image: Visual Studio 2017
clone_folder: C:\workspace\OPC-UA\quasar\
build:
  verbosity: normal
notifications:
- provider: Email
  to:
  - quasar-developers@cern.ch
  subject: quasar windows build status changed
  on_build_success: false
  on_build_failure: false
  on_build_status_changed: true

environment:
  WINDOWS_DEPENDENCIES_DIR: C:\workspace\OPC-UA\quasar-windows-dependencies
  ENVIRONMENT_SETTINGS_FILE: C:\workspace\OPC-UA\quasar-windows-dependencies\env.ps1

# scripts that run after cloning repository
install:
  - ps : |
         Write-Output "Cleaning and recreating windows dependencies dir: ${env:WINDOWS_DEPENDENCIES_DIR}"
         if(Test-Path "${env:WINDOWS_DEPENDENCIES_DIR}")
         {
           Remove-Item "${env:WINDOWS_DEPENDENCIES_DIR}" -Force -Recurse;
         }
         New-Item -ItemType Directory -Force -Path "${env:WINDOWS_DEPENDENCIES_DIR}"

  - ps : Write-Output "Installing python packages..."
  - ps : python -m pip install lxml==3.4.4 # specific version is important
  - ps : python -m pip install pygit2
  - ps : Write-Output "Installed python packages"

  # use chocolatey wherever possible
  - ps : Write-Output "Installing chocolatey packages..."
#  - ps : choco install --yes --limit-output git
#  - ps : choco install --yes --limit-output astyle
#  - ps : choco install --yes --limit-output xsltproc # provides xmllint
#  - ps : choco install --yes --limit-output nuget.commandline
  - ps : Write-Output "Installed chocolatey packages"

  # if no chocolatey package available use nuget (often the case for libs)
  - ps : Write-Output "Installing nuget packages to ${env:WINDOWS_DEPENDENCIES_DIR}"
#  - ps : nuget install xercesc -NonInteractive -ExcludeVersion -OutputDirectory "${env:WINDOWS_DEPENDENCIES_DIR}"
#  - ps : nuget install openssl-vc141-static-x86_64 -NonInteractive -ExcludeVersion -OutputDirectory "${env:WINDOWS_DEPENDENCIES_DIR}"
#  - ps : nuget install libxml2  -NonInteractive -ExcludeVersion -OutputDirectory "${env:WINDOWS_DEPENDENCIES_DIR}"
#  - ps : nuget install boost-vc141 -NonInteractive -ExcludeVersion -OutputDirectory "${env:WINDOWS_DEPENDENCIES_DIR}"
#  - ps : Write-Output "Installed nuget packages to "${env:WINDOWS_DEPENDENCIES_DIR}"

  # no chocolatey, no nuget ? Do it manually
  - ps : Write-Output "Installing xsdcxx..."
  - ps : Invoke-WebRequest "https://codesynthesis.com/download/xsd/4.0/windows/i686/xsd-4.0.msi" -OutFile "${env:WINDOWS_DEPENDENCIES_DIR}\xsd-4.0.msi"
  - ps : Start-Process "${env:WINDOWS_DEPENDENCIES_DIR}\xsd-4.0.msi" -Wait -ArgumentList /quiet
  - ps : |
         if(Test-Path "C:\Program Files (x86)\CodeSynthesis XSD 4.0\bin\xsd.exe")
         {
           Write-Output "Must change xsd.exe to xsdcxx.exe to avoid clash with built-in windows xsd.exe (on some systems)";
           Copy-Item -Path "C:\Program Files (x86)\CodeSynthesis XSD 4.0\bin\xsd.exe" -Destination "C:\Program Files (x86)\CodeSynthesis XSD 4.0\bin\xsdcxx.exe";
         }
         else
         {
           Write-Output "ERROR! Failed to locate installed xsdcxx binary file, required for generating C++ handler code from XSD schema";
           Exit 1;
         }
  - ps : Write-Output "Installed xsdcxx"

  #
  # create the environment into a runnable environment file, then run it
  #
  - ps : |
         Write-Output "Cleaning existing environment settings file: "${env:ENVIRONMENT_SETTINGS_FILE}""
         if(Test-Path "${env:ENVIRONMENT_SETTINGS_FILE}")
         {
           Remove-Item "${env:ENVIRONMENT_SETTINGS_FILE}"
         }
         New-Item -ItemType "file" -Path "${env:WINDOWS_DEPENDENCIES_DIR}" -Name "env.ps1"
  - ps : |
         Write-Output "Writing environment settings to file: ${env:ENVIRONMENT_SETTINGS_FILE}"
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('Write-Output "starting set..."')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('[System.Environment]::SetEnvironmentVariable("PATH", $env:PATH+";C:\Program Files (x86)\CodeSynthesis XSD 4.0\bin", "Machine")')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('[System.Environment]::SetEnvironmentVariable("CODE_SYNTHESYS_XSD_PATH_HEADERS", "C:\Program Files (x86)\CodeSynthesis XSD 4.0\include", "Machine")')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('[System.Environment]::SetEnvironmentVariable("BOOST_PATH_HEADERS", "'+${env:WINDOWS_DEPENDENCIES_DIR}+'\boost\lib\native\include", "Machine")')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('[System.Environment]::SetEnvironmentVariable("BOOST_PATH_LIBS", "'+${env:WINDOWS_DEPENDENCIES_DIR}+'", "Machine")')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('[System.Environment]::SetEnvironmentVariable("LIBXML2_PATH_HEADERS", "'+${env:WINDOWS_DEPENDENCIES_DIR}+'\libxml2\build\native\include", "Machine")')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('[System.Environment]::SetEnvironmentVariable("LIBXML2_PATH_LIBS", "'+${env:WINDOWS_DEPENDENCIES_DIR}+'\libxml2\build\native\lib\v110\x64\Release\static\cdecl", "Machine")')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('[System.Environment]::SetEnvironmentVariable("OPENSSL_PATH_HEADERS", "'+${env:WINDOWS_DEPENDENCIES_DIR}+'\openssl-vc141-static-x86_64\build\native\include", "Machine")')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('[System.Environment]::SetEnvironmentVariable("OPENSSL_PATH_LIBS", "'+${env:WINDOWS_DEPENDENCIES_DIR}+'\openssl-vc141-static-x86_64\build\native\lib\x64\static\Release", "Machine")')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('[System.Environment]::SetEnvironmentVariable("XERCESC_PATH_HEADERS", "'+${env:WINDOWS_DEPENDENCIES_DIR}+'\xercesc\build\native\include", "Machine")')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('[System.Environment]::SetEnvironmentVariable("XERCESC_PATH_LIBS", "'+${env:WINDOWS_DEPENDENCIES_DIR}+'\xercesc\build\native\lib\x64\v110\Release", "Machine")')
         Add-Content "${env:ENVIRONMENT_SETTINGS_FILE}" ('Write-Output "set complete!"')
  - ps : |
         Write-Output "Setting windows dependency paths using runnable settings file: "${env:ENVIRONMENT_SETTINGS_FILE}""
         "${env:ENVIRONMENT_SETTINGS_FILE}"

  # start build, note optional module open62541-compat required: provides OPC-UA back-end
  - cmd : set
  - cmd : python quasar.py set_build_config open6_win_configuration.cmake
  - cmd : python quasar.py enable_module open62541-compat
  - cmd : python quasar.py prepare_build Release
  - cmd : python quasar.py build Release

  - ps : Write-Output "Build completed!"
  - ps : |
         if(Test-Path bin/OpcUaServer.exe)
         {
          Write-Output "Succesfully Built QUASAR." ;
         }
         else
         {
          Write-Output "ERROR! There was a problem building QUASAR; The script will now terminate." ;
          Exit 1;
         }

# uncomment to block VM deletion for investigating broken builds.
on_finish:
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
