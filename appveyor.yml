# version format
version: 1.0.{build}
image: Visual Studio 2017
build:
  verbosity: normal

# Operating system (build VM template)
os: Windows Server 2012
platform: x64
configuration: Release

# scripts that run after cloning repository
install:
  - ps : Write-Output "Installing python packages..."
  - ps : python --version
  - ps : python -m pip install lxml
  - ps : Write-Output "Installed python packages"

  # use chocolatey wherever possible
  - ps : Write-Output "Installing chocolatey packages..."
  - ps : choco --version
  - ps : choco install --yes git
  - ps : choco install --yes astyle
  - ps : choco install --yes xsltproc # provides xmllint 
  - ps : choco install --yes nuget.commandline
  - ps : Write-Output "Installed chocolatey packages"

  # if no chocolatey package available use nuget (often the case for libs)
  - ps : Write-Output "Installing nuget packages..."
  - ps : nuget install xerces-c-static
  - ps : nuget install boost-vc141
  - ps : nuget install openssl-vc141
  - ps : Write-Output "Installed nuget packages"

  # no chocolatey, no nuget ? Do it manually 
  - ps : Write-Output "Installing xsdcxx..."
  - ps : wget https://codesynthesis.com/download/xsd/4.0/windows/i686/xsd-4.0.msi -OutFile C:\temp\xsd-4.0.msi
  - ps : msiexec /i C:\temp\xsd-4.0.msi /quiet /qn /norestart /log C:\temp\xsd-install.log
  - ps : if(-Not Test-Path "C:\Program Files (x86)\CodeSynthesis XSD 3.3\bin\xsd.exe")
        {
          Write-Error "Failed to locate installed xsdcxx binary file, required for generating C++ handler code from XSD schema";
          Exit 1;
        }
        else
        {
          Copy-Item -Path "C:\Program Files (x86)\CodeSynthesis XSD 3.3\bin\xsd.exe" -Destination "C:\Program Files (x86)\CodeSynthesis XSD 3.3\bin\xsdcxx.exe";
          xsdcxx --version;
        }
- ps : Write-Output "Installed xsdcxx"        


# open6 specific operations
  - cmd : python quasar.py enable_module open62541-compat
  - cmd : python quasar.py set_build_config open6_win_configuration.cmake
  - cmd : python quasar.py prepare_build Release
  - cmd : cd open62541-compat && python prepare.py && cd ..

# start build
  - cmd : echo "Calling build...(note always returns 0 to mask any internal msbuild errors - exe is checked below)"
  - cmd : python quasar.py build Release && exit 0
  - cmd : echo "build complete!"
  - ps : if(Test-Path bin/OpcUaServer.exe)
         {
          Write-Output "Succesfully Built QUASAR." ;
         }
         else
         {
          Write-Error "There was a problem building QUASAR; The script will now terminate." ;
          Exit ;
         }

# uncomment to block VM deletion for investigating broken builds.
on_finish:
  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
